<div class="crear-plan-container">
  <h1 class="page-title">Crear plan de venta</h1>

  <div *ngIf="isLoadingData" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando datos...</p>
  </div>

  <form *ngIf="!isLoadingData" [formGroup]="planVentaForm" (ngSubmit)="crearPlanDeVenta()" class="plan-form">
    <div class="form-content">

      <div class="form-field">
        <label class="field-label">Periodo *</label>
        <select
          title="Periodo"
          class="form-select"
          formControlName="periodo"
          [class.error]="periodo?.invalid && (periodo?.dirty || periodo?.touched)">
          <option [ngValue]="null" disabled>Seleccione un periodo</option>
          <option *ngFor="let p of periodos" [value]="p">{{ p }}</option>
        </select>
        <div *ngIf="periodo?.invalid && (periodo?.dirty || periodo?.touched)" class="error-message">
          <div *ngIf="periodo?.errors?.['required']">El periodo es requerido.</div>
        </div>
      </div>

      <div class="form-field">
        <label class="field-label">Producto *</label>
        <select
          title="Producto"
          class="form-select"
          formControlName="producto"
          [class.error]="producto?.invalid && (producto?.dirty || producto?.touched)">
          <option [ngValue]="null" disabled>Seleccione un producto</option>
          <option *ngFor="let prod of productos" [value]="prod.id">
            {{ prod.name }} - {{ prod.batch }}
          </option>
        </select>
        <div *ngIf="producto?.invalid && (producto?.dirty || producto?.touched)" class="error-message">
          <div *ngIf="producto?.errors?.['required']">El producto es requerido.</div>
        </div>
      </div>

      <div class="form-field">
        <label class="field-label">Meta (unidades) *</label>
        <input
          type="number"
          class="form-input"
          formControlName="metaUnidades"
          placeholder="Ej: 1200"
          [class.error]="metaUnidades?.invalid && (metaUnidades?.dirty || metaUnidades?.touched)">
        <div *ngIf="metaUnidades?.invalid && (metaUnidades?.dirty || metaUnidades?.touched)" class="error-message">
          <div *ngIf="metaUnidades?.errors?.['required']">La meta es requerida.</div>
          <div *ngIf="metaUnidades?.errors?.['min']">La meta debe ser mayor a 0.</div>
        </div>
      </div>

      <div class="form-field">
        <label class="field-label">Zona *</label>
        <select
          title="Zona"
          class="form-select"
          formControlName="zona"
          [class.error]="zona?.invalid && (zona?.dirty || zona?.touched)">
          <option [ngValue]="null" disabled>Seleccione una zona</option>
          <option *ngFor="let z of zonas" [value]="z.id">{{ z.description }}</option>
        </select>
        <div *ngIf="zona?.invalid && (zona?.dirty || zona?.touched)" class="error-message">
          <div *ngIf="zona?.errors?.['required']">La zona es requerida.</div>
        </div>
      </div>



      <div class="form-field">
        <label class="field-label">Vendedor asociado *</label>
        <select
          title="Vendedor"
          class="form-select"
          formControlName="vendedorAsociado"
          [class.error]="vendedorAsociado?.invalid && (vendedorAsociado?.dirty || vendedorAsociado?.touched)">
          <option [ngValue]="null" disabled>Seleccione un vendedor</option>
          <option *ngFor="let vendedor of vendedoresFiltrados" [value]="vendedor.id">
            {{ vendedor.full_name }} - {{ vendedor.doi }}
          </option>
        </select>
        <small class="field-hint" *ngIf="vendedoresFiltrados.length === 0 && searchVendedor?.value">
          No se encontraron vendedores con ese criterio
        </small>
        <div *ngIf="vendedorAsociado?.invalid && (vendedorAsociado?.dirty || vendedorAsociado?.touched)" class="error-message">
          <div *ngIf="vendedorAsociado?.errors?.['required']">El vendedor es requerido.</div>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn-primary" [disabled]="isLoading">
        {{ isLoading ? 'CREANDO...' : 'CREAR PLAN DE VENTA' }}
      </button>
    </div>
  </form>

  <div *ngIf="toastMessage" class="toast" [ngClass]="toastType">
    {{ toastMessage }}
  </div>
</div>
